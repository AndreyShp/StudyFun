TranslatorController={containers:{searchField:$("#search"),translationContainer:$("#translationContainer")},lastSearch:null,lastTranslate:null,skipSearch:null,getUrl:function(n){return ServerData.GetPath(n)},loadQuery:function(n,t){if(this.lastSearch=n,this.skipSearch===!0){this.skipSearch=null;return}$.getJSON(this.getUrl(ServerData.Patterns.Urls.SearchUrl),{query:n},$.proxy(function(i){i!=null&&this.lastSearch==n&&(i.IsChangedLanguage&&LanguagePanel.OnChangeLanguage(),i.NewPattern&&(this.lastSearch=i.NewPattern,this.containers.searchField.val(this.lastSearch),this.skipSearch=!0,this.containers.searchField.keyup()),i.Words!=null&&t(i.Words))},this))},getText:function(n){return Speaker.GetWordHtml(n)},select:function(n){return this.showTranslationByQuery(n),n},showTranslationByQuery:function(n){return n?(this.lastTranslate=n,$.getJSON(this.getUrl(ServerData.Patterns.Urls.GetTranslations),{query:n},$.proxy(function(t){var r,u,i,f;this.lastTranslate==n&&(t!=null&&t.length>0?(r=this.getTranslationsAsHtml(t),u=String.format(ServerData.Patterns.Title,n,t[0].Text),f=LanguagePanel.GetLanguages(),i=String.format(ServerData.Patterns.Urls.SpecialUrl,f.from.ShortName,f.to.ShortName,n)):(r='Извините, перевод для "'+n+'" не найден',u=ServerData.Patterns.TitleWithoutQuery,i=ServerData.Patterns.Urls.UrlWithoutQuery),i=this.getUrl(i),this.containers.translationContainer.html(r),this.changeTitleAndUrl(u,i,n),this.containers.searchField.select())},this)),!0):!1},changeTitleAndUrl:function(n,t,i){$("title").html(n),window.history.replaceState({query:i},n,t),SharePanel.Update(t,n)},getTranslationsAsHtml:function(n){var t=$("<ol>");return $.each(n,$.proxy(function(n,i){var r=this.getText(i),u=$("<li>").html(r);return t.append(u),!0},this)),t},searchKeyUp:function(n){n.which==13&&this.Translate(!1),this.clearIfFieldEmpty()},clearIfFieldEmpty:function(){var n=this.containers.searchField.val();n||(this.containers.translationContainer.html(""),this.changeTitleAndUrl(ServerData.Patterns.TitleWithoutQuery,ServerData.Patterns.Urls.UrlWithoutQuery)),this.changeErrorSearch()},Init:function(){var n={source:$.proxy(this.loadQuery,this),updater:$.proxy(this.select,this)};this.containers.searchField.on("keyup",$.proxy(this.searchKeyUp,this)).on("input paste",$.proxy(this.clearIfFieldEmpty(),this)).on("click",$.proxy(this.changeErrorSearch,this)).typeahead(n).focus()},Translate:function(n){var t=this.containers.searchField.val(),i=this.showTranslationByQuery(t);i||n!==!0||this.changeErrorSearch(!0)},changeErrorSearch:function(n){Global.setInputStyle(this.containers.searchField,n)}},$(function(){TranslatorController.Init()});
