VisualDictionarySalesController={TR_SELECTOR:"tr[data-id]",getIdByElem:function(n){var t=n.parents(VisualDictionarySalesController.TR_SELECTOR);return t.data("id")},Init:function(){function s(n,t){var i={isSuccess:n,removeLabels:!0,container:$("#salesMessage"),text:t},r=new Message(i);r.Show()}var o="#emailField",f=0,e,n,r,u;GlobalBusiness!=null&&GlobalBusiness.TopPanel!=null&&(f=GlobalBusiness.TopPanel.GetHeight()),e=$("#selectedBlock"),e.sticky({topSpacing:f,center:!0});var c=function(n){var i=Math.round(n*100),r=parseInt(i/100),u=i%100,t=u;return u<10&&(t="0"+t),r+=","+t},t={consent:ko.observable(!1),summPrice:ko.observable(),count:ko.observable(),hasCount:ko.observable()},i=function(n,i){t.count(n),t.summPrice(c(i)),t.hasCount(n>0)};if(i(ServerData.SelectedCount,ServerData.SelectedSummPrice),n=$(VisualDictionarySalesController.TR_SELECTOR).find("input[type='checkbox']"),r=$("#allCheckboxes"),r.click(function(){var t=$(this).is(":checked");t?(n.prop("checked",!0),i(ServerData.AllCount,ServerData.SummPrice)):(n.removeAttr("checked"),i(0,0))}),n.click(function(){var f=0,t=!0,u=0;$.each(n,function(n,i){var e=$(i),o,r;return e.is(":checked")?(o=VisualDictionarySalesController.getIdByElem(e),r=GlobalBusiness.findById(o),r!=null&&(u=Math.round(u+r.Price*100)),f++,!0):(t=!1,!0)}),t?r.prop("checked",!0):r.removeAttr("checked"),i(f,t?ServerData.SummPrice:u/100)}),MailBlock({url:ServerData.Urls.SendToMail,mailBlockSelector:"#mailBlock",emailFieldSelector:o,showBtnBlockSelector:"#showMailBlockBtn",sendBtnSelector:"#sendUniqueIdBtn",showMessage:s,dataToPostModifier:function(n){n.uniqueDownloadId=ServerData.UniqueDownloadId}}),CopyToClipboard({copyToClipboardBtnSelector:"#copyToClipboardBtn",textSelector:"#salesUniqueId"}),$("#buySelectedBtn").click(function(){$("#consentCbx").prop("checked",!1),$(o).val(""),t.consent(!1),$("#salesFinishStepWindow").modal("show"),GlobalBusiness.Counter.reachGoal(GlobalBusiness.Counter.Ids.BuyClick)}),$("#payBtn").click(function(){var t=[],i;$.each(n,function(n,i){var r=$(i),u;return r.is(":checked")?(u=VisualDictionarySalesController.getIdByElem(r),t.push(u),!0):!0}),i="{ ids:"+JSON.stringify(t)+', uniqueDownloadId:"'+ServerData.UniqueDownloadId+'"}',$.ajax({url:ServerData.Urls.Buy,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:i,success:function(n){var i=n!=null&&n.success,t;i?location.href=n.paymentUrl:(t=n!=null?n.message:"Извините, не удалось перейти к оплате.<br />Попробуйте еще раз через несколько секунд",s(!1,t))}}),GlobalBusiness.Counter.reachGoal(GlobalBusiness.Counter.Ids.PayClick)}),ko.applyBindings(t),u=$("#sales-scroll-to-elem"),u.length>0){var l=10,a=$(window).height(),h=u.offset().top,v=u.outerHeight(),y=h-f-e.outerHeight()-l;h+v>=a&&$("html, body").scrollTop(y)}},ShowPreview:function(n){var r="wordsContainer",t="#"+r,e=VisualDictionarySalesController.getIdByElem($(n)),i=GlobalBusiness.findById(e),u=encodeURIComponent(i.Name),o=String.format(ServerData.Urls.Image,u),s="<div class='sales-preview-container'><div class='pull-left'><img src='"+o+"' alt='Визуальный словарь на тему &laquo;"+i.Name+"&raquo;'></div><div class='pull-left sales-preview-words' id='"+r+"'></div></div>",h=new PrettyWindow({header:"Предпросмотр визуального словаря &laquo;"+i.Name+"&raquo;",body:s}),f;$(t).loading("Загрузка слов"),f=String.format(ServerData.Urls.PreviewInfo,u),$.getJSON(f,function(n){var r,i;if($(t).loading("hide"),n==null){Global.showMessage(t,!1,"Извините, не удалось получить слова.<br />Закройте окно предпросмотра и попробуйте еще раз через несколько секунд");return}r=function(n){var t="<ul>";return $.each(n,function(n,i){return t+="<li>"+i.Source.Text+"</li>",!0}),t+="</ul>"},i=parseInt(n.length/2),n.length%2>0&&i++;var u=r(n.slice(0,i)),f=r(n.slice(i,n.length)),e="<div class='pull-left'>"+u+"</div><div class='pull-left'>"+f+"</div>";$(t).html(e)}),h.Show()}},$(function(){VisualDictionarySalesController.Init()});
